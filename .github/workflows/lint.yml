name: Lint Pipeline

on:
  push:
    branches: [ main, develop, feat/* ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  pull-requests: write

jobs:
  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install black==24.10.0 isort==5.13.2 flake8>=7.0.0
    
    - name: Check code formatting with Black
      id: black
      run: |
        black --check --diff . || echo "::error::Black formatting check failed. Run 'black .' to fix."
        black --check --diff . && echo "passed=true" >> $GITHUB_OUTPUT || echo "passed=false" >> $GITHUB_OUTPUT
    
    - name: Check import sorting with isort
      id: isort
      run: |
        isort --check-only --diff . || echo "::error::isort import sorting check failed. Run 'isort .' to fix."
        isort --check-only --diff . && echo "passed=true" >> $GITHUB_OUTPUT || echo "passed=false" >> $GITHUB_OUTPUT
    
    - name: Run Flake8 linting
      id: flake8
      run: |
        flake8 --max-line-length=120 --extend-ignore=E203,W503 src/common/ src/manager/ src/downloader/ src/translator/ src/scanner/ src/consumer/ || echo "::error::Flake8 linting failed. Fix the issues shown above."
        flake8 --max-line-length=120 --extend-ignore=E203,W503 src/common/ src/manager/ src/downloader/ src/translator/ src/scanner/ src/consumer/ && echo "passed=true" >> $GITHUB_OUTPUT || echo "passed=false" >> $GITHUB_OUTPUT
    
    - name: Comment on PR with lint results
      if: github.event_name == 'pull_request' && (steps.black.outputs.passed == 'false' || steps.isort.outputs.passed == 'false' || steps.flake8.outputs.passed == 'false')
      uses: actions/github-script@v7
      with:
        script: |
          const body = `## ⚠️ Code Quality Checks Failed
          
          Some code quality checks failed. Please fix the following issues:
          
          ${{ steps.black.outputs.passed == 'false' && '### ❌ Black Formatting
          Code formatting check failed. Run the following command to fix:
          \`\`\`bash
          black .
          \`\`\`
          ' || '' }}
          
          ${{ steps.isort.outputs.passed == 'false' && '### ❌ isort Import Sorting
          Import sorting check failed. Run the following command to fix:
          \`\`\`bash
          isort .
          \`\`\`
          ' || '' }}
          
          ${{ steps.flake8.outputs.passed == 'false' && '### ❌ Flake8 Linting
          Linting check failed. Please review and fix the issues shown in the workflow logs.
          ' || '' }}
          
          **Quick Fix:** Run \`make format\` to auto-fix formatting and import sorting issues.
          
          ---
          *This comment is automatically generated by the Lint Pipeline*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
    
    - name: Create summary
      if: always()
      run: |
        echo "## Lint Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Black | ${{ steps.black.outputs.passed == 'true' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| isort | ${{ steps.isort.outputs.passed == 'true' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Flake8 | ${{ steps.flake8.outputs.passed == 'true' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY

